<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="https://www.jetbrains.com/teamcity/schemas/2020.2/project-config.xsd">

  <name>MindTrace for Playwright</name>
  <description>AI-Governed Test Automation with Self-Healing + Governance + Audit</description>

  <build-type>
    <id>MindTrace_Native</id>
    <name>Style 1 - Playwright Native</name>

    <settings>
      <property name="artifactRules" value="
        test-results/** => test-results.zip
        playwright-report/** => playwright-report.zip
        mindtrace-artifacts/** => mindtrace-artifacts.zip
        runs/** => runs.zip
        history/** => history.zip
        screenshots/** => screenshots.zip
      "/>

      <property name="buildNumberPattern" value="%build.counter%"/>
      <property name="checkoutDir" value="."/>
      <property name="executionTimeoutMin" value="60"/>
    </settings>

    <vcs-settings>
      <vcs-entry-ref root-id="MindTrace_GitRoot"/>
    </vcs-settings>

    <requirements>
      <equals name="env.NODE_VERSION" value="18.x"/>
    </requirements>

    <build-runners>

      <!-- Step 1: Install Dependencies -->
      <runner id="npm_install" name="Install Dependencies" type="simpleRunner">
        <parameters>
          <param name="script.content" value="
            cd frameworks/style1-native
            npm ci
            npx playwright install --with-deps
          "/>
          <param name="teamcity.step.mode" value="default"/>
          <param name="use.custom.script" value="true"/>
        </parameters>
      </runner>

      <!-- Step 2: Run MindTrace-Enhanced Tests (with deterministic run name) -->
      <runner id="mindtrace_tests" name="Run MindTrace Tests" type="simpleRunner">
        <parameters>
          <param name="script.content" value="
            cd frameworks/style1-native

            export CI=true
            export CI_PROVIDER=teamcity
            export MINDTRACE_RUN_NAME=tc-%build.number%

            npx mindtrace run --style native --run-name &quot;$MINDTRACE_RUN_NAME&quot;
          "/>
          <param name="teamcity.step.mode" value="default"/>
          <param name="use.custom.script" value="true"/>
        </parameters>
      </runner>

      <!-- Step 3: Explicit Artifact Validation (hard fail if broken) -->
      <runner id="validate_artifacts" name="Validate Artifacts" type="simpleRunner">
        <parameters>
          <param name="script.content" value="
            cd frameworks/style1-native
            export MINDTRACE_RUN_NAME=tc-%build.number%
            npx mindtrace validate-artifacts --run &quot;$MINDTRACE_RUN_NAME&quot;
          "/>
          <param name="teamcity.step.mode" value="default"/>
          <param name="use.custom.script" value="true"/>
        </parameters>
      </runner>

      <!-- Step 4: Governance Gate (policy-based pass/fail) -->
      <runner id="governance_gate" name="Governance Gate" type="simpleRunner">
        <parameters>
          <param name="script.content" value="
            cd frameworks/style1-native
            export MINDTRACE_RUN_NAME=tc-%build.number%
            npx mindtrace gate --run &quot;$MINDTRACE_RUN_NAME&quot;
          "/>
          <param name="teamcity.step.mode" value="default"/>
          <param name="use.custom.script" value="true"/>
        </parameters>
      </runner>

      <!-- Step 5: Finalize Audit Trail -->
      <runner id="finalize_audit" name="Finalize Audit Trail" type="simpleRunner">
        <parameters>
          <param name="script.content" value="
            cd frameworks/style1-native
            export MINDTRACE_RUN_NAME=tc-%build.number%
            npx mindtrace finalize-run --run &quot;$MINDTRACE_RUN_NAME&quot;
          "/>
          <param name="teamcity.step.mode" value="default"/>
          <param name="use.custom.script" value="true"/>
        </parameters>
      </runner>

      <!-- Step 6: Index Run to History -->
      <runner id="index_history" name="Index History" type="simpleRunner">
        <parameters>
          <param name="script.content" value="
            cd frameworks/style1-native
            export MINDTRACE_RUN_NAME=tc-%build.number%
            npx mindtrace index-run --run &quot;$MINDTRACE_RUN_NAME&quot;
          "/>
          <param name="teamcity.step.mode" value="default"/>
          <param name="use.custom.script" value="true"/>
        </parameters>
      </runner>

      <!-- Step 7: Generate Report Bundle -->
      <runner id="generate_report" name="Generate MindTrace Report" type="simpleRunner">
        <parameters>
          <param name="script.content" value="
            cd frameworks/style1-native
            export MINDTRACE_RUN_NAME=tc-%build.number%
            npx mindtrace report --run &quot;$MINDTRACE_RUN_NAME&quot; --output ../../reports --format markdown
          "/>
          <param name="teamcity.step.mode" value="default"/>
          <param name="use.custom.script" value="true"/>
        </parameters>
      </runner>

    </build-runners>

    <build-triggers>
      <build-trigger id="vcsTrigger" type="vcsTrigger">
        <parameters>
          <param name="enableQueueOptimization" value="true"/>
          <param name="quietPeriodMode" value="DO_NOT_USE"/>
        </parameters>
      </build-trigger>
    </build-triggers>

    <cleanup>
      <policy>
        <option name="artifactDays" value="7"/>
        <option name="artifactPatterns" value="+:**"/>
      </policy>
    </cleanup>
  </build-type>

  <parameters>
    <param name="env.OPENAI_API_KEY" value="%vault:openai/api-key%"/>
    <param name="env.BASE_URL" value="https://app.staging.company.com"/>
    <param name="env.CI" value="true"/>
    <param name="env.CI_PROVIDER" value="teamcity"/>
    <param name="env.HEADLESS" value="true"/>
    <param name="env.PARALLEL_WORKERS" value="4"/>

    <param name="env.MINDTRACE_HEAL_ENABLED" value="true"/>
    <param name="env.MINDTRACE_RCA_ENABLED" value="true"/>
    <param name="env.MINDTRACE_ALLOW_FLAKY_ONLY" value="true"/>
    <param name="env.MINDTRACE_FAIL_ON_ANY_FAILURE" value="true"/>

    <param name="env.SLACK_WEBHOOK_URL" value="%vault:slack/webhook-url%"/>
    <param name="env.JIRA_API_TOKEN" value="%vault:jira/api-token%"/>
  </parameters>

</project>
